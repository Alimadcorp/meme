<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Meme of the Day by Alimad Co</title>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-app.js";
      import {
        getFirestore,
        collection,
        doc,
        query,
        orderBy,
        onSnapshot,
        addDoc,
        updateDoc,
        serverTimestamp,
      } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyBR1UeKEAJV4x3YOjzMFDsaSUwQiLgJNFQ",
        authDomain: "commentspagetests.firebaseapp.com",
        projectId: "commentspagetests",
        storageBucket: "commentspagetests.firebasestorage.app",
        messagingSenderId: "560501874254",
        appId: "1:560501874254:web:2cab2358cb517c3418ad1f",
        measurementId: "G-HYDSZ89BLH",
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const appname = "meme";
      const feedbackForm = document.getElementById("feedbackForm");
      const commentTextarea = document.getElementById("comment");
      const commentsList = document.getElementById("comments-list");
      let commentsArray = [];
      async function addComment(commentText) {
        try {
          await addDoc(collection(db, appname), {
            text: commentText,
            timestamp: serverTimestamp(),
          });
        } catch (error) {
          console.error("Error adding comment: ", error);
        }
      }
      function fetchComments() {
        const commentsRef = query(collection(db, appname), orderBy("timestamp"));
        onSnapshot(commentsRef, (snapshot) => {
          commentsArray = [];
          snapshot.forEach((doc) => {
            const commentData = doc.data();
            commentData.id = doc.id;
            commentsArray.push(commentData);
          });
          displayCommentsWithDelay(true);
        });
      }
      function formatTimeAgo(timestamp) {
        const now = new Date();

        const diffInSeconds = Math.floor((now - timestamp) / 1000);
        if (diffInSeconds < 60) {
          return diffInSeconds <= 0
            ? "Just now"
            : `${diffInSeconds} second${diffInSeconds === 1 ? "" : "s"} ago`;
        }
        const diffInMinutes = Math.floor(diffInSeconds / 60);
        if (diffInMinutes < 60) {
          return `${diffInMinutes} minute${diffInMinutes === 1 ? "" : "s"} ago`;
        }
        const diffInHours = Math.floor(diffInMinutes / 60);
        if (diffInHours < 24) {
          return `${diffInHours} hour${diffInHours === 1 ? "" : "s"} ago`;
        }
        const diffInDays = Math.floor(diffInHours / 24);
        if (diffInDays <= 14) {
          return `${diffInDays} day${diffInDays === 1 ? "" : "s"} ago`;
        }
        return timestamp.toLocaleDateString("en-US", {
          day: "2-digit",
          month: "short",
          year: "numeric",
        });
      }

      function refreshCom() {
        let newArray = [];
        const commentsRef = query(collection(db, appname), orderBy("timestamp"));
        onSnapshot(commentsRef, (snapshot) => {
          snapshot.forEach((doc) => {
            const commentData = doc.data();
            commentData.id = doc.id;
            newArray.push(commentData);
          });
          if (JSON.stringify(newArray) !== JSON.stringify(commentsArray)) {
            commentsArray = newArray;
            displayCommentsWithDelay(false);
          }
        });
      }
      function forceRefresh() {
        let newArray = [];
        const commentsRef = query(collection(db, appname), orderBy("timestamp"));
        onSnapshot(commentsRef, (snapshot) => {
          snapshot.forEach((doc) => {
            const commentData = doc.data();
            commentData.id = doc.id;
            newArray.push(commentData);
          });
          commentsArray = newArray;
          displayCommentsWithDelay(false);
        });
      }
      function scrollToBottom() {
        const commentsContainer = document.getElementById("comments-section");
        commentsContainer.scrollTop = commentsContainer.scrollHeight;
      }
      let adding = false;
      async function displayCommentsWithDelay(scrolll) {
        if (adding) return;
        adding = true;
        commentsList.innerHTML = "";
        for (const comment of commentsArray) {
          if (scrolll) {
            await new Promise((resolve) => setTimeout(resolve, 10));
          } // 50ms delay
          const timestamp = comment.timestamp
            ? comment.timestamp.toDate()
            : new Date();
          const timeAgo = formatTimeAgo(timestamp);
          const commentElement = document.createElement("div");
          commentElement.classList.add("comment");
          commentElement.innerHTML = `
            <p>${comment.text}</p>
            <div class="comment-time">${timeAgo}</div>
          `;
          commentsList.appendChild(commentElement);
        }
        await new Promise((resolve) => setTimeout(resolve, 50));
        if (scrolll) scrollToBottom();
        adding = false;
      }

      document.getElementById("sub").addEventListener("click", () => {
        const commentText = commentTextarea.value;
        if (commentText) {
          addComment(commentText);
          commentTextarea.value = "";
        }
      });
      document.addEventListener("DOMContentLoaded", () => {
        fetchComments();
        setInterval(refreshCom, 8000);
        setInterval(forceRefresh, 61234);
      });

      function fetchMeme() {
        const commentsRef = query(collection(db, "memeoftheday"));
        onSnapshot(commentsRef, (snapshot) => {
          snapshot.forEach((doc) => {
            const today = new Date().toISOString().split("T")[0];
            let data = doc.data();
            if(data.memeby != "Unknown"){
              document.getElementById("memeby").innerHTML = "Meme updated by " + data.memeby;
            }else{
              document.getElementById("memeby").innerHTML = "Loading...";
            }
            if (today == data.day) {
              displayMeme(data);
            } else {
              loadNewMeme();
            }
          });
        });
      }
      async function uploadMeme(data) {
        try {
          const docRef = doc(db, "memeoftheday", "today");

          const filteredData = {
            title: data.title || "No Title",
            preview: data.preview || ["No Preview"],
            subreddit: data.subreddit || "No Subreddit",
            postLink: data.postLink || "No Link",
            day: data.day || new Date().toISOString().split("T")[0],
            author: data.author || "Unknown Author",
            url: data.url || "No URL",
            memeby: "Unknown",
            time: serverTimestamp(),
          };

          await updateDoc(docRef, filteredData);
        } catch (error) {
          console.error("Error updating entry: ", error);
        }
      }


      function hideLoader() {
        document.getElementById("loading-indicator").style.display = "none";
      }

      function loadNewMeme() {
        const mainImg = document.getElementById("imag");
        const previewImg = document.getElementById("preview");
        mainImg.style.display = previewImg.style.display = "none";
        document.getElementById("loading-indicator").style.display = "inline";
        fetch("https://meme-api.com/gimme")
          .then((res) => res.json())
          .then((data) => {
            displayMeme(data);
            uploadMeme(data);
          })
          .catch((err) => {
            console.error(err);
            document.getElementById("title").innerHTML = "Failed to load meme.";
            hideLoader();
          });
      }

      function displayMeme(data) {
        hideLoader();
        const mainImg = document.getElementById("imag");
        const previewImg = document.getElementById("preview");
        previewImg.style.display = "inline";
        previewImg.src = data.preview[1];
        mainImg.src = data.url;

        previewImg.onload = () => {
          previewImg.classList.remove("hidden");
          previewImg.style.display = "inline";
        };

        mainImg.onload = () => {
          previewImg.classList.add("hidden");
          mainImg.classList.remove("hidden");
          previewImg.style.display = "none";
          mainImg.style.display = "inline";
          hideLoader();
        };

        document.getElementById("title").innerHTML = data.title;
        document.getElementById("author").innerHTML = "Author: " + data.author;
        document.getElementById("subreddit").innerHTML =
          "Subreddit: r/" + data.subreddit;
        document.getElementById("link").innerHTML = "View Post";
        document.getElementById("link").href = data.postLink;
      }
      window.onload = fetchMeme;
    </script>
    <style>
          body {
            background-color: #121212;
            color: #e0e0e0;
            font-family: Arial, sans-serif;
            text-align: center;
            margin: 0;
            padding: 20px;
          }

          h1 {
            margin: 20px 0;
            color: #bb86fc;
          }

          img {
            max-width: 90%;
            height: auto;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            margin: 20px 0;
          }

          img.hidden {
            display: none;
          }

          a {
            color: #bb86fc;
            text-decoration: none;
          }

          a:hover {
            text-decoration: underline;
          }

          button {
            background-color: #bb86fc;
            color: #121212;
            border: none;
            border-radius: 4px;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 20px;
          }

          button:hover {
            background-color: #3700b3;
          }

          #loading-indicator {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
          }

          #loading-indicator span {
            color: #bb86fc;
            font-size: 24px;
            margin-right: 10px;
          }

          #loading-indicator .spinner {
            border: 4px solid #121212;
            border-top: 4px solid #bb86fc;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
          }
          .feedback-container {
          position: static; /* Let it flow with the page */
          margin-top: 1.5rem; /* Space between buttons and comments */
          background-color: rgba(255, 255, 255, 0.05);
          padding: 1rem;
          border-radius: 8px;
          box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
          bottom: 1rem;
          left: 1rem;
          right: 1rem;
          overflow-x: hidden;
          overflow-y: auto;
          z-index: 9999;
          max-height: 90%;
        }

      textarea {
        font-size: 1rem;
      }
        #sub {
          margin: 1rem 0; /* Adjust spacing */
        }

      .feedback-container h1,
      .feedback-container h2 {
        color: #eee;
        text-align: center;
        font-size: 1rem; /* Increased size for readability */
      }

      textarea {
        height: 5rem; /* Adjusted height */
        padding: 1rem;
        border-radius: 5px;
        resize: none;
        width: 90%;
      }

      .feedback-container button {
        background-color: #4CAF50;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 1rem;
        margin-top: 1rem;
        width: 80%;
      }

      #comments-section {
        margin-top: 1.5rem;
        max-height: 50vh;
        overflow-y: auto;
      }

      .comment-time {
        font-size: 11px;
        color: #888;
      }
      .comment {
        position: relative;
        overflow: auto;
        background-color: #4446;
        padding: 0.1rem;
        border-radius: 5px;
        margin-bottom: 0.1rem;
        border: 1px solid #888;
      }
      #sub {
        margin: 0.5rem auto; /* Center horizontally */
        display: block; /* Make it a block element */
        box-shadow: 2px 4px 10px rgba(0, 0, 0, 0.2);
        font-size: 13px;
        width: 80%; /* Adjust width as needed */
        color: #fff;
        background-color: #0a0a;
        padding: 6px;
        cursor: pointer;
      }
      .comment p {
        margin: 0;
        font-size: 13px;
      }

          @keyframes spin {
            from {
              transform: rotate(0deg);
            }
            to {
              transform: rotate(360deg);
            }
          }
    </style>
  </head>
  <body>
    <div id="loading-indicator">
      <span><h6 id="memeby">Loading...</h6></span>
      <div class="spinner"></div>
      <br />
    </div>

    <h1>Meme of the Day by Alimad</h1>
    <img src="#" id="preview" alt="Preview" class="hidden" />
    <img src="#" id="imag" alt="Meme of the day" class="hidden" />
    <h2 id="title">Loading...</h2>
    <h3 id="author"></h3>
    <h3 id="subreddit"></h3>
    <a href="#" id="link" target="_blank"></a><br /><br />

    <div class="feedback-container">
      <div id="comments-section">
        <div id="comments-list"></div>
      </div>
      <h1>Leave a Comment</h1>
      <form id="feedbackForm">
        <textarea
          id="comment"
          placeholder="Write your comment here..."
          required
        ></textarea>
      </form>
      <button id="sub">Submit</button>
    </div>
    <p class="footer">
      Made by<a href="https://alimadcorp.github.io/site/social.html"
        ><strong>&nbspMuhammad Ali</strong></a
      >.
    </p>
  </body>
</html>
